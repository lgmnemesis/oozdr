rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
    	// Reject all by default
      allow read, write: if false;
    }
    
    match /users/{userId} {
    	allow read: if isOwner();
    	allow create: if isSignedIn() && isValidForUserDocCreate();
    	allow update: if isOwner() && isValidForUserDocUpdate();
    	allow delete: if isOwner();
    }
    
    match /profiles/{userId} {
    	allow read: if isOwner();
    	allow create: if isSignedIn() && isValid();
    	allow update: if isOwner() && isValid();
    	allow delete: if isOwner();
    }
    
    match /connections/{userId} {
    	allow read: if isOwner();
    	allow create: if isSignedIn() && isValid();
    	allow update: if isOwner() && isValid();
    	allow delete: if isOwner();
    }
    
    match /matches/{userId} {
    	allow read: if canReadChat();
    	allow create: if false;
    	allow update: if canUpdateChat();
    	allow delete: if false;
    }
  }
  
  function isValidForUserDocCreate() {
  	return isValid() && incomingData().roles.admin == false;
  }
  
  function isValidForUserDocUpdate() {
  	return isValid() && incomingData().roles == existingData().roles;
  }
  
  function isValid() {
  	return incomingData().user_id == request.auth.uid;
  }
  
  function isValidChat() {
  	return incomingData().id == existingData().id 
  		&& incomingData().participates == existingData().participates
      && incomingData().messages.hasAll(existingData().messages)
      && incomingData().messages.size() == existingData().messages.size() + 1
      && request.resource.size() == resource.size();
  }
  
  function isOwner() {
  	return isSignedIn() && request.auth.uid == existingData().user_id;
  }
  
  function isSignedIn() {
  	return request.auth != null;
	}
  
  function isParticipate() {
  	return request.auth.uid in existingData().participates;
  }
  
  function canReadChat() {
		return isParticipate();
  }
  
  function canUpdateChat() {
		return canReadChat() && isValidChat();   
  }

  
  function existingData() {
  	return resource.data;
  }
  
  function incomingData() {
  	return request.resource.data;
  }
}
  