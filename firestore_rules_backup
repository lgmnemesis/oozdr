rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
    	// Reject all by default
      allow read, write: if false;
    }
    
    match /profiles/{userId} {
    	allow read: if isProfileOwner(userId) || isAdmin();
    	allow create: if canCreateProfileDoc(userId) && isValidProfile();
    	allow update: if isProfileOwner(userId) && isValidProfile();
    	allow delete: if false; // TODO: delete user data from functions, when user is deleted
    }
    
    match /connections/{connectionId} {
    	allow read: if isOwner() || isAdmin();
    	allow create: if isSignedIn() && isValidForConnectionCreateDoc();
    	allow update: if isOwner() && isValidForConnectionUpdateDoc();
    	allow delete: if isOwner();
    }
    
    match /matches/{matchId} {
    	allow read: if canReadChat() || isAdmin();
    	allow create: if false;
    	allow update: if canUpdateChat();
    	allow delete: if false;
    }
    
    match /feedbacks/form_feedbacks {
    	allow read: if false || isAdmin();
    	allow create: if false;
    	allow update: if canUpdateFeedback();
    	allow delete: if false;
    }
    
    
    // Functions Section
    
    function isAdmin() {
      return request.auth.uid == '1BNI43bMo8Zt6WWYgOVR6lSPQKB2';
    }

    function canCreateProfileDoc(userId) {
    	return isSignedIn() && request.auth.uid == userId;
    }
    
    function canUpdateFeedback() {
    	return existingData().messages.size() < 500
      	&& request.resource.size() == resource.size()
      	&& incomingData().messages.size() == existingData().messages.size() + 1;
    }
    
    function isValidForConnectionDoc() {
    	return isValid()
      	&& incomingData().user_mobile == request.auth.token.phone_number
      	&& incomingData().id == request.auth.uid + '_' + incomingData().basicInfo.mobile;
    }
  
    function isValidForConnectionCreateDoc() {
      return isValidForConnectionDoc()
        && incomingData().createdAt == request.time;
    }

    function isValidForConnectionUpdateDoc() {
      return isValidForConnectionDoc()
        && ((request.writeFields.size() == 1)
        && (('isNewMatch' in request.writeFields)
            || ('isBlocked' in request.writeFields)
            || ('basicInfo' in request.writeFields)));
    }

    function isValid() {
      return incomingData().user_id == request.auth.uid;
    }

    function isValidProfile() {
      return isValid() 
      	&& incomingData().basicInfo.mobile == request.auth.token.phone_number
      	&& incomingData().fcmTokens.size() <= 5;
    }

    function isValidChat() {
      return request.resource.size() == resource.size()
      	&& incomingData().id == existingData().id 
        && incomingData().participates == existingData().participates
        && incomingData().firstParty.user_id == existingData().firstParty.user_id
        && incomingData().firstParty.user_mobile == existingData().firstParty.user_mobile
        && incomingData().secondParty.user_id == existingData().secondParty.user_id
        && incomingData().secondParty.user_mobile == existingData().secondParty.user_mobile
        && incomingData().messages.hasAll(existingData().messages)
        && existingData().messages.size() < 500
        && (incomingData().messages.size() == existingData().messages.size() + 1
         || ((incomingData().firstParty.hasNewMessages == false
          && incomingData().firstParty.hasNewMessages != existingData().firstParty.hasNewMessages)
           || (incomingData().secondParty.hasNewMessages == false
          && incomingData().secondParty.hasNewMessages != existingData().secondParty.hasNewMessages)));
    }

		function isProfileOwner(userId) {
    	return isOwner() && request.auth.uid == userId;
    }
    
    function isOwner() {
      return isSignedIn() && request.auth.uid == existingData().user_id;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isParticipate() {
      return request.auth.uid in existingData().participates;
    }

    function canReadChat() {
      return isParticipate();
    }

    function canUpdateChat() {
      return canReadChat() && isValidChat();   
    }


    function existingData() {
      return resource.data;
    }

    function incomingData() {
      return request.resource.data;
    }
    
  }
}